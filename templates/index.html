<!DOCTYPE html>
<html>
<head>
    <title>eFinancialCareers Job Search Results</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-12Z087Z0KZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-12Z087Z0KZ');
    </script>
        
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', 'Segoe UI', Arial, sans-serif;
        }        
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            table-layout: fixed;
        }

        th, td {
            padding: 8px;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            border-bottom: 1px solid #f1f5f9;
        }

        /* Keep your original column widths */
        th:nth-child(1), td:nth-child(1) { width: 2%; }    /* # */
        th:nth-child(2), td:nth-child(2) { width: 8%; }    /* Source */
        th:nth-child(3), td:nth-child(3) { width: 20%; }   /* Job Title */
        th:nth-child(4), td:nth-child(4) { width: 13%; }   /* Company */
        th:nth-child(5), td:nth-child(5) { width: 12%; }   /* Location */
        th:nth-child(6), td:nth-child(6) { width: 37%; }   /* Job Description */
        th:nth-child(7), td:nth-child(7) { width: 8%; }    /* Link */

        th {
            background: #f8fafc;
            color: #1f2937;
            font-weight: 600;
            font-size: 12px;
            text-transform: none;
            letter-spacing: 0;
            padding: 12px 8px;
            border-bottom: 2px solid #e2e8f0
        }
                
        input.column-filter {
            width: 100%;
            padding: 6px 8px;
            box-sizing: border-box;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }
        
        
        .description-container {
            max-height: 120px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .description-container.expanded {
            max-height: none;
        }
        .toggle {
            color: blue;
            cursor: pointer;
        }
        input.column-filter {
            width: 100%;
            padding: 6px 8px;
            box-sizing: border-box;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }
        .spinner-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div class="bg-slate-800 text-white p-6 mb-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Find Me A Job</h1>
                    <p class="text-slate-300 mt-2">Skip the scrolling. Filter to your perfect job</p>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-slate-300">
                        <span class="text-sm">Welcome,</span>
                        <span class="font-semibold text-white">{{ session.username }}</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="#" onclick="showFeedbackModal()" class="text-slate-300 hover:text-white transition-colors text-base flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.955 8.955 0 01-2.292-.298l-5.133 1.552a1 1 0 01-1.249-1.249l1.552-5.133A8.955 8.955 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                            </svg>
                            Report Issue
                        </a>
                        <a href="/settings" class="text-slate-300 hover:text-white transition-colors text-base flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Settings
                        </a>
                        <a href="/logout" class="bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded-md text-base font-medium transition-colors">
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6">

        <!-- Feedback Success Message -->
        {% if request.args.get('feedback') == 'sent' %}
        <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="text-green-800 font-medium">Thank you! Your feedback has been sent successfully.</span>
            </div>
        </div>
        {% endif %}
        
        <!-- How It Works Section -->
        <div class="mb-8">
            <div class="bg-blue-50 border border-blue-200 rounded-xl overflow-hidden">
                <button 
                    onclick="toggleHelp()" 
                    class="w-full px-6 py-4 text-left bg-gray-700 hover:bg-gray-600 transition-colors flex items-center justify-between"
                >    
                    <span class="text-lg font-semibold text-white">üìñ How it works - Click to expand</span>
                    <svg id="help-arrow" class="w-5 h-5 text-white transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="help-content" class="hidden px-6 py-6 bg-white">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="text-3xl mb-3">1Ô∏è‚É£</div>
                            <h5 class="font-bold text-slate-800 mb-2">Search</h5>
                            <p class="text-sm text-slate-600">Enter job title, location, and run your search</p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-3">2Ô∏è‚É£</div>
                            <h5 class="font-bold text-slate-800 mb-2">Save</h5>
                            <p class="text-sm text-slate-600">Save good searches with a name for later use</p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-3">3Ô∏è‚É£</div>
                            <h5 class="font-bold text-slate-800 mb-2">Schedule</h5>
                            <p class="text-sm text-slate-600">Set daily/weekly/monthly automation using the ‚è∞ icon</p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-3">4Ô∏è‚É£</div>
                            <h5 class="font-bold text-slate-800 mb-2">Get Emails</h5>
                            <p class="text-sm text-slate-600">Receive Excel files with fresh job results automatically</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TOP ROW: Search form and saved searches side by side -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            
            <!-- LEFT CARD: Search Filters -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    
               
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
                    </svg>
                    Search Filters
                    
                </h2>
                
                <form method="POST" action="/app">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #1e3a8a;">
                            Search on:
                        </label>
                        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; font-weight: 500;">
                                <input type="radio" name="source" value="efinancialcareers" {{ 'checked' if source == 'efinancialcareers' or not source else '' }} style="margin-right: 6px;">
                                eFinancialCareers
                            </label>
                            <label style="display: flex; align-items: center; font-weight: 500;">
                                <input type="radio" name="source" value="careerjet" {{ 'checked' if source == 'careerjet' else '' }} style="margin-right: 6px;">
                                CareerJet
                            </label>
                            <label style="display: flex; align-items: center; font-weight: 500; color: #6b7280;">
                                <input type="radio" name="source" value="both" {{ 'checked' if source == 'both' else '' }} style="margin-right: 6px;" opacity: 0.5;" disabled>
                                Both <span style="font-size: 12px; color: #999; margin-left: 4px; font-style: italic;">(Coming Soon)</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="title" style="display: block; font-weight: bold;">Job Title or Keyword:</label>
                        <input type="text" id="title" name="title" value="{{ title }}" placeholder="e.g. Risk & Control" style="width: 100%; padding: 8px;">
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="location" style="display: block; font-weight: bold;">Location:</label>
                        <input type="text" id="location" name="location" value="{{ location }}" placeholder="e.g. New York" style="width: 100%; padding: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                      <!-- eFinancialCareers seniority dropdown -->
                      <div id="efc-seniority">
                        <label for="seniority" style="display: block; font-weight: bold;">Seniority Level:</label>
                        <select id="seniority" name="seniority" style="width: 100%; padding: 8px;">
                          <option value="">All Levels</option>
                          <option value="intern" {{ 'selected' if seniority == 'intern' else '' }}>Intern/Graduate</option>
                          <option value="junior" {{ 'selected' if seniority == 'junior' else '' }}>Junior</option>
                          <option value="analyst" {{ 'selected' if seniority == 'analyst' else '' }}>Analyst</option>
                          <option value="associate" {{ 'selected' if seniority == 'associate' else '' }}>Associate/Mid Level</option>
                          <option value="avp" {{ 'selected' if seniority == 'avp' else '' }}>AVP/Senior</option>
                          <option value="vp" {{ 'selected' if seniority == 'vp' else '' }}>Vice President/Principal</option>
                          <option value="svp" {{ 'selected' if seniority == 'svp' else '' }}>Senior Vice President/Head Of</option>
                          <option value="director" {{ 'selected' if seniority == 'director' else '' }}>Director</option>
                          <option value="md" {{ 'selected' if seniority == 'md' else '' }}>Managing Director</option>
                          <option value="csuite" {{ 'selected' if seniority == 'csuite' else '' }}>C Suite</option>
                        </select>
                      </div>
  
                      <!-- CareerJet experience keywords input -->
                      <div id="cj-experience" style="display: none;">
                        <label for="experience_keywords" style="display: block; font-weight: bold;">Seniority Level:</label>                          
                        <input type="text" id="experience_keywords" name="experience_keywords" 
                               placeholder="e.g., senior, junior, entry level, director" 
                               style="width: 100%; padding: 8px;" value="{{ experience_keywords or '' }}">
                        <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">üí°CareerJet uses keyword matching for seniority (e.g., "VP" searches for "vice president OR VP").</small>
                      </div>
                    </div>                    

                    <div style="margin-bottom: 10px;">
                        <label for="max_jobs" style="display: block; font-weight: bold;">
                          Number of Search Results:
                          <span style="font-size: 12px; font-style: italic; color: #555;">(Max: 50)</span>
                        </label>
                        <input type="number" id="max_jobs" name="max_jobs" min="1" max="50" value="{{ max_jobs }}" style="width: 100px; padding: 8px;">
                    </div>

                    <button type="submit" name="action" value="run" class="px-5 py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-800 shadow-md transition-colors">üîç Run Search</button>
                    <span id="loading-spinner" style="display: none; margin-left: 10px;">
                        <div class="spinner-icon"></div>
                        <small>Searching... This takes 2-5 minutes (respectful delays for server-friendly scraping)</small>
                    </span>
                </form>
            </div>

            <!-- RIGHT CARD: Saved Searches -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    Saved Searches
                </h2>
                
                <p style="font-size: 12px; color: #666; margin-bottom: 16px;">
                  Only the 5 most recent searches are shown.
                </p>
                
                <div id="saved-searches-list">
                  {% include 'partials/saved_searches.html' %}
                </div>

                <form method="POST" action="/download_selected" id="multi-download-form">
                  <button type="submit"
                          style="margin-top: 12px; padding: 6px 12px; font-size: 14px; background-color: #1e293b; color: white; border: none; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                      üì• Download Selected Files
                  </button>
                </form>
            </div>
        </div>

        <!-- BOTTOM ROW: Search Results full width -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    Search Results
                    {% if special_message %}
                        <span class="ml-3 px-3 py-1 bg-orange-100 text-orange-800 text-sm font-medium rounded-full">{{ special_message }}</span>
                    {% elif jobs %}
                        <span class="ml-3 px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">{{ jobs|length }} jobs found</span>
                    {% endif %}
                </h2>

                                                     
                {% if jobs %}
                <form method="POST" action="/download">
                    <button type="submit" class="px-4 py-2 bg-slate-700 text-white text-sm font-semibold rounded-lg hover:bg-slate-800 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download Excel
                    </button>
                </form>
                {% endif %}
            </div>

            {% if active_search_name %}
                <p style="margin-top: -10px; color: #444;">
                    Showing results from saved search: <strong style="color: #002060;">{{ active_search_name }} - {{ timestamp }}</strong>
                </p>
            {% endif %}


            <!-- Show info message -->
            {% if info %}
                <div style="background: #dbeafe; border: 1px solid #3b82f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="color: #1e40af; margin: 0; font-weight: 500;">{{ info }}</p>
                </div>
            {% endif %}

            {% if jobs %}
            <!-- Save This Search Section -->
            <div class="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-300 rounded-lg p-4 mb-6 shadow-sm">
                <form method="POST">
                    <!-- Hidden fields to preserve search criteria -->
                    <input type="hidden" name="title" value="{{ title }}">
                    <input type="hidden" name="location" value="{{ location }}">
                    <input type="hidden" name="seniority" value="{{ seniority }}">
                    <input type="hidden" name="max_jobs" value="{{ max_jobs }}">
                    <input type="hidden" name="source" value="{{ source }}">
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <div class="flex items-center mr-4">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                </svg>
                                <span class="text-sm font-medium text-slate-700">Like these results?</span>
                            </div>
                            <div class="flex items-center space-x-3 flex-1">
                                <input 
                                    type="text" 
                                    name="search_name"
                                    placeholder="Name this search (e.g., 'Senior AI Roles - NYC')" 
                                    class="flex-1 px-3 py-2 border border-blue-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    style="max-width: 300px;"
                                >
                                <button type="submit" name="action" value="save" class="px-4 py-2 bg-slate-700 text-white text-sm font-medium rounded-md hover:bg-slate-800 transition-colors flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                    </svg>
                                    Save Search
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </form>
            </div>
                
               
                <table id="resultsTable" style="table-layout: fixed; margin-bottom: 20px; width: 100%;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Source</th>
                            <th>Job Title</th>
                            <th>Company</th>
                            <th>Location</th>
                            <th>Job Description</th>
                            <th>Link</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th><input class="column-filter" type="text" placeholder="Filter Company..." onkeyup="filterTable(3, this.value)"></th>
                            <th><input class="column-filter" type="text" placeholder="Filter Location..." onkeyup="filterTable(4, this.value)"></th>
                            <th><input class="column-filter" type="text" placeholder="Filter Description..." onkeyup="filterTable(5, this.value)"></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ job.source | default('EFC') }}</td>
                            <td>{{ job.title }}</td>
                            <td>{{ job.company }}</td>
                            <td>{{ job.location }}</td>
                            <td>
                                <div class="description-container">
                                    {{ job.formatted_description | safe }}
                                </div>
                                {% if job.description|length > 1000 %}
                                <div>
                                    <a class="toggle" onclick="toggleMore(this)">Show more</a>
                                </div>
                                {% endif %}
                            </td>
                            <td><a href="{{ job.link }}" target="_blank">View Job</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            
            {% elif jobs is defined and jobs|length == 0 %}
                <p>No jobs found.</p>
            {% endif %}
        </div>
    </div>

    <script>
        function toggleMore(el) {
            const container = el.closest('td').querySelector('.description-container');
            container.classList.toggle('expanded');
            el.textContent = container.classList.contains('expanded') ? 'Show less' : 'Show more';
        }

        function filterTable(colIndex, query) {
            const table = document.getElementById("resultsTable");
            const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
            query = query.toLowerCase().trim();

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cell = rows[i].getElementsByTagName("td")[colIndex];
                const text = cell.innerText || cell.textContent;
                row.style.display = text.toLowerCase().includes(query) ? "" : "none"; 
            }
        }
    </script>

    <script>
      function toggleRename(index) {
        const form = document.getElementById("rename-form-" + index);
        form.style.display = form.style.display === "none" ? "block" : "none";
      }
    </script>

    <script>
    function toggleSchedule(index) {
      const el = document.getElementById('schedule-form-' + index);
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function saveSchedule(index, frequency) {
      fetch('/save_schedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `search_index=${index}&frequency=${frequency}`
      })
      .then(response => {
        if (response.ok) {
          const confirm = document.getElementById('confirm-' + index);
          confirm.style.display = 'inline';
          setTimeout(() => confirm.style.display = 'none', 1500);

          // Refresh the saved searches to show updated frequency
          setTimeout(() => {
            refreshSavedSearches();
          }, 500);  
        } else {
          alert('Failed to save schedule.');
        }
      });
    }
    </script>

    <script>
    function showToast(message) {
      const toast = document.createElement('div');
      toast.innerHTML = `<strong>‚úÖ Download Ready</strong><br><span style="font-size: 12px;">${message}</span>`;
      toast.style.background = "#e6ffed";
      toast.style.color = "#006400";
      toast.style.padding = "10px 16px";
      toast.style.marginTop = "10px";
      toast.style.borderRadius = "8px";
      toast.style.boxShadow = "0 2px 6px rgba(0, 0, 0, 0.1)";
      toast.style.fontFamily = "'Open Sans', sans-serif";
      toast.style.fontSize = "13px";
      toast.style.opacity = "0";
      toast.style.transition = "opacity 0.4s ease";
      
      const container = document.getElementById('toast-container');
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = "1";
      }, 100);

      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
      }, 4000);
    }
    </script>

    <script>
      const dismissMessages = new Set();
      let checkedSearches = new Set();

      function dismissDownloadMsg(index) {
        dismissMessages.add(index);
        const el = document.getElementById('download-msg-' + index);
        if (el) el.style.display = 'none';
      }

        function refreshSavedSearches() {
          // Capture checked values BEFORE destroying the form
          const checkedValues = Array.from(document.querySelectorAll('.download-checkbox:checked'))
                           .map(cb => cb.value);
  
          fetch('/saved_searches_partial')
            .then(response => response.text())
            .then(html => {
              const container = document.getElementById('saved-searches-list');
              container.innerHTML = html;

              // Restore checked state
              checkedValues.forEach(name => {
                const restored = container.querySelector(`.download-checkbox[value="${name}"]`);
                if (restored) restored.checked = true;
              });

              dismissMessages.forEach(index => {
                const el = document.getElementById('download-msg-' + index);
                if (el) el.style.display = 'none';
              });
            })
            .catch(error => console.error('Error refreshing saved searches:', error));
        }      
              
    </script>

    <script>
    function deleteSearch(index) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/delete_saved_search';

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'index';
      input.value = index;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
    </script>
   
    <script>
    // Complete download solution
    (function() {
      function handleDownloadForm() {
        const form = document.getElementById('multi-download-form');
        if (!form) return;
    
        // Remove any existing listeners
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
    
        // Add our listener
        newForm.addEventListener('submit', function(e) {
          e.preventDefault();
      
          const checkedBoxes = document.querySelectorAll('.download-checkbox:checked');
          const values = Array.from(checkedBoxes).map(cb => cb.value);
      
          console.log('NEW SOLUTION - Captured values:', values);
      
          if (values.length === 0) {
            alert('Please select files to download');
            return;
          }
      
          // Create form data manually
          const formData = new FormData();
          values.forEach(value => formData.append('selected_files', value));
      
          // Submit via fetch
          fetch('/download_selected', {
            method: 'POST',
            body: formData
          }).then(response => response.blob())
            .then(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'Selected_Results.zip';
              a.click();
            });
        });
      }
  
      // Run on page load and after any DOM changes
      handleDownloadForm();
  
      // Re-run after saved searches refresh
      const originalRefresh = window.refreshSavedSearches;
      window.refreshSavedSearches = function() {
        if (originalRefresh) originalRefresh.apply(this, arguments);
        setTimeout(handleDownloadForm, 100);
      };
    })();
    </script>
   
       
    <script>
    document.querySelector('form:not(#multi-download-form)').addEventListener('submit', function(e) {
        // Only show spinner for Run Search, not Save Search
        if (e.submitter && e.submitter.value === 'run') {
            document.getElementById('loading-spinner').style.display = 'inline-block';
        }
    });
    </script>

    <script>
    // Show spinner when clicking saved search links
    document.addEventListener('DOMContentLoaded', function() {
        // Find all saved search links (they have URLs like /load_search/0, /load_search/1, etc.)
        const savedSearchLinks = document.querySelectorAll('a[href*="/load_search/"]');
    
        savedSearchLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                // Show the same spinner as for new searches
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.style.display = 'inline-block';
                }
            });
        });
    });
    </script>

    
    <script>
    function toggleHelp() {
        const content = document.getElementById('help-content');
        const arrow = document.getElementById('help-arrow');
    
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            arrow.style.transform = 'rotate(0deg)';
        }
    }
    </script>

<!-- Feedback Modal -->
<div id="feedbackModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 w-full">
        <h3 class="text-lg font-bold text-slate-800 mb-4">Send Feedback</h3>
        
        <form method="POST" action="/submit_feedback">
            <div class="mb-4">
                <label for="feedback_type" class="block text-sm font-medium text-slate-700 mb-2">Type</label>
                <select id="feedback_type" name="feedback_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="bug">Bug Report</option>
                    <option value="feature">Feature Request</option>
                    <option value="general">General Feedback</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="feedback_message" class="block text-sm font-medium text-slate-700 mb-2">Message</label>
                <textarea id="feedback_message" name="feedback_message" rows="4" 
                    placeholder="Describe the issue or your feedback..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    required maxlength="1000"></textarea>
            </div>
            
            <div class="mb-6">
                <label for="feedback_email" class="block text-sm font-medium text-slate-700 mb-2">Email (optional)</label>
                <input type="email" id="feedback_email" name="feedback_email" 
                    placeholder="your@email.com (for follow-up)" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex space-x-4">
                <button type="button" onclick="hideFeedbackModal()" 
                    class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                    Send Feedback
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showFeedbackModal() {
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function hideFeedbackModal() {
    document.getElementById('feedbackModal').classList.add('hidden');
    // Clear the form
    document.getElementById('feedback_message').value = '';
    document.getElementById('feedback_email').value = '';
    document.getElementById('feedback_type').value = 'bug';
}

// Close modal when clicking outside
document.getElementById('feedbackModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideFeedbackModal();
    }
});
</script>


<script>
function toggleSeniorityUI() {
    const efcRadio = document.querySelector('input[name="source"][value="efinancialcareers"]');
    const cjRadio = document.querySelector('input[name="source"][value="careerjet"]');
    const efcSeniority = document.getElementById('efc-seniority');
    const cjExperience = document.getElementById('cj-experience');
    
    console.log('toggleSeniorityUI called');
    console.log('CareerJet checked:', cjRadio ? cjRadio.checked : 'radio not found');
    
    if (cjRadio && cjRadio.checked) {
        efcSeniority.style.display = 'none';
        cjExperience.style.display = 'block';
        console.log('Showing CareerJet experience input');
    } else {
        efcSeniority.style.display = 'block';
        cjExperience.style.display = 'none';
        console.log('Showing eFC seniority dropdown');
    }
}

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up seniority toggle');
    toggleSeniorityUI();
    
    // Add event listeners to radio buttons
    document.querySelectorAll('input[name="source"]').forEach(radio => {
        radio.addEventListener('change', function() {
            console.log('Radio button changed to:', this.value);
            toggleSeniorityUI();
        });
    });
});
</script>

</body>
</html>
    

